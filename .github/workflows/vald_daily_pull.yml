name: Daily VALD Data Pull

permissions:
  contents: read   # prevent writing to public repo

on:
  schedule:
    - cron: "0 19 * * *"   # 11am PST
  workflow_dispatch:

jobs:
  run-vald:
    runs-on: ubuntu-22.04

    env:
      RENV_CONFIG_REPOS_OVERRIDE: https://packagemanager.posit.co/cran/__linux__/jammy/latest
      R_BUILD_VIGNETTES: false
      R_CHECK_BUILD_VIGNETTES: false
      DATA_OUTPUT_DIR: data-repo/data

    steps:
      # Checkout PUBLIC repo (code only)
      - name: Checkout code repo
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.0'

      - name: Restore renv environment
        uses: r-lib/actions/setup-renv@v2

      # Checkout PRIVATE data repo
      - name: Checkout private data repo
        uses: actions/checkout@v4
        with:
          repository: UCLA-Football-Strength-App-DATA
          token: ${{ secrets.DATA_REPO_PAT }}
          path: data-repo

      - name: Run VALD data pull
        env:
          VALD_CLIENT_ID: ${{ secrets.VALD_CLIENT_ID }}
          VALD_CLIENT_SECRET: ${{ secrets.VALD_CLIENT_SECRET }}
          VALD_TENANT_ID: ${{ secrets.VALD_TENANT_ID }}
          VALD_REGION: ${{ secrets.VALD_REGION }}
        run: Rscript scripts/vald_import.R

      - name: Run Catapult data pull
        env:
          CATAPULT_API_TOKEN: ${{ secrets.CATAPULT_API_TOKEN }}
        run: Rscript scripts/catapult_import.R

      - name: Convert CSVs to RDS
        run: Rscript scripts/csv_to_rds.R

      # Commit ONLY to the private repo
      - name: Commit and push data to private repo
        run: |
          cd data-repo
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data
          git commit -m "Daily VALD & Catapult data update" || echo "No changes"
          git push
